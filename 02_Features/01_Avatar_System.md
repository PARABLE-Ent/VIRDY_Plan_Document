# 아바타 시스템

> **문서 버전**: 1.0
> **최종 수정일**: 26.01.30 13:20
> **작성자**: 임경섭

---

## 1. 개요

아바타 시스템은 사용자가 자신의 3D 캐릭터를 VIRDY에 가져와 실시간으로 구동하는 기능이다. <br/>
VRM 포맷 아바타를 업로드하여 Actor에 불러오고, 트래커와 연결하여 실시간 모션캡처 아바타로 동작한다.

---

## 2. 핵심 기획

### 2.1 지원 아바타 포맷

| 포맷 | 상태 | 설명 |
|------|------|------|
| **VRM 0.x** | ✅ | 현재 주력 지원 포맷. VRoid Studio, Blender 등에서 제작 가능 |
| **VRM 1.0** | 📋 | 차세대 VRM 포맷, 지원은 되나 검증 X |
| **VSF** | 📋 | VSeeFace 포맷, 지원중이나 일부 VSF 스크립트는 테스트 필요 |
| **자체 확장자** | 📋 | 애니메이션/스크립트 내장 포맷, 배포 할 VIRDY SDK에서 빌드 |

### 2.2 아바타 로딩 파이프라인

| 단계 | 동작 | 설명 |
|------|------|------|
| 1 | 파일 선택 | 로컬 VRM 파일 업로드 / 리스트 내 선택 |
| 2 | VRM 파싱 | UniVRM으로 VRM 파일 로드 및 메타데이터 추출 |
| 3 | 머티리얼 변환 | MToon 셰이더 → URP Toon Lit 셰이더로 자동 변환 |
| 4 | 본 매핑 | Humanoid 본 자동 매핑 + IK 설정 |
| 5 | 표정 설정 | BlendShapeProxy 기반 52종 ARKit BlendShape 매핑 |
| 6 | Puppet 생성 | 트래커 데이터를 아바타에 연결하는 중간 계층 생성 |
| 7 | 씬 배치 | 아바타를 Scene에 불러오기 |

### 2.3 아바타 저장 및 관리

#### 저장 경로

| 위치 | 용도 |
|------|------|
| **Firebase Storage** | 클라우드 원본 저장 (암호화) |
| **로컬 캐시** | 빠른 재로딩용 (앱 데이터 폴더) |

#### 아바타 목록 관리

| 항목 | 설명 |
|------|------|
| 업로드 | 로컬 VRM → Firebase Storage 암호화 업로드 |
| 다운로드 | Firebase → 로컬 캐시 저장 |
| 삭제 | Firebase 삭제 (로컬 캐시도 삭제?) |
| 캐시 | 이미 다운로드한 아바타는 로컬 캐시에서 바로 로드 |

### 2.4 표정 시스템

VIRDY는 ARKit 호환 52종 BlendShape를 지원한다.

#### BlendShape 카테고리

| 카테고리 | 주요 항목 |
|---------|---------|
| 눈 (Eyes) | 깜빡임, 시선 방향, 찡그림, 크게뜨기 |
| 눈썹 (Brows) | 내리기, 올리기 (안쪽/바깥쪽) |
| 입/턱 (Mouth/Jaw) | 미소, 찡그림, 오므리기, 벌리기, 좌우 이동 |
| 볼/코/혀 | 볼 부풀리기, 코 찡그림, 혀 내밀기 |


#### 민감도 조절

사용자가 부위별로 트래킹 민감도를 조절할 수 있다.

| 파라미터 | 범위 | 설명 |
|----------|------|------|
| 시선 강도 (Gaze) | 0~1 | 눈동자 움직임 반영 정도 |
| 눈썹 강도 (Eyebrow) | 0~1 | 눈썹 움직임 반영 정도 |
| 입/볼 강도 (Mouth) | 0~1 | 입과 볼 움직임 반영 정도 |

#### Facial Blendshape Config 세부 조절

ARKit 52 Blendshape를 개별 세부 조절할 수 있다. <br/>
e.g. 움직임을 0.4 정도만 움직여도 0.8로 Output이 나오게 하는 기능.

### 2.5 아바타 블렌드셰이프 커스텀 설정

기본 표정 외에 사용자가 추가 BlendShape를 설정할 수 있다.

| 기능 | 설명 |
|------|------|
| BlendShape 목록 조회 | VRM에 포함된 모든 BlendShape 표시 |
| 커스텀 표정 매핑 | 특정 키/트리거에 BlendShape 조합 할당 |
| GameObject 연동 | BlendShape와 연계하여 오브젝트 활성화/비활성화 |

### 2.6 액터(Actor) 구조

Actor는 아바타 + 트래커 조합의 단위이다.

| 항목 | 설명 |
|------|------|
| 슬롯 수 | 최대 6개 |
| 구성 | 아바타 1개 + Facial 트래커 1개 + Body 트래커 1개 + Hand 트래커 1개 |
| 저장 | 슬롯별 설정이 로컬에 JSON으로 저장됨. 재접속시 자동 로드 |

---

## 3. 설계 시 고려사항

### 3.1 암호화 및 저작권 보호

- VRM 파일은 업로드/캐시 시 암호화 적용
- 로컬 캐시에서도 암호화 상태로 저장되어 직접 파일 추출 방지
- VRM 메타데이터의 저작권 정보 존중 (AllowedUser, ViolentUsage 등)

### 3.2 메모리 관리

- 아바타 텍스처는 메모리 사용의 주요 원인
- 월드 진입 시 아바타 + 월드가 동시에 로드되므로 메모리 예산 관리 필요
- 다수 아바타 동시 로드 시 (멀티유저) LOD 또는 품질 조절 검토
  - VIRDY-SDK를 통한 Avatar Build 시, Analysis 분석 및 자동 최적화 기능 개발 예정

### 3.4 네트워크 동기화 대상

아바타의 네트워크 동기화 데이터:

| 데이터 | 수량 | 설명 |
|--------|------|------|
| 본 회전 | 22개 | Hips ~ Toes |
| 손가락 포즈 | 40개 | 양손 각 20개 |
| 표정 값 | 100개 | BlendShape 값 |
| 위치 | 3개 | Hip + 손 오프셋 |

---

## 4. 엣지 케이스 및 예외 처리

| 상황 | 대응 |
|------|------|
| 지원하지 않는 VRM 버전 업로드 | 오류 메시지 + 지원 버전 안내 |
| VRM 본 매핑 불완전 (필수 본 누락) | 경고 표시, 누락 본은 기본 포즈 |
| 아바타 파일 손상 | 로드 실패 → 재업로드 안내 |
| 개인 Storage 용량 초과 | 업로드 실패 안내, 기존 아바타 정리 및 Pro / 상위 라이선스 권유 |
| 로컬 캐시 손상 | 자동 재다운로드 |
| 동일 아바타를 중복 업로드 | 기존 아바타 덮어쓰기 안내. 중복 감지는 파일명, VRM 버전 |

---

## 5. 향후 확장 가능성

| 항목 | 설명 | 우선순위 |
|------|------|---------|
| **VRM 1.0** | 차세대 VRM 포맷 지원 | 높음 |
| **자체 확장자** | 애니메이션/스크립트 내장 아바타 포맷, SDK에서 빌드 | 높음 |

---

## 관련 문서

- [트래커 시스템](./02_Tracker_System.md)
- [SDK](./06_SDK.md)
- [네트워크 시스템](./05_Network_System.md)
- [사용자 플로우](../01_Product/02_User_Flow.md)
