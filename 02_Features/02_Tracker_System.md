# 트래커 시스템

> **문서 버전**: 1.0
> **최종 수정일**: 26.01.30 13:20
> **작성자**: 임경섭

---

## 1. 개요

트래커 시스템은 다양한 모션캡처 장비를 VIRDY에 연결하여 실시간으로 아바타를 구동하는 핵심 기능이다. Facial(얼굴), Body(바디), Hand(핸드) 3개 카테고리로 총 14종 이상의 장비를 지원하며, 개인 크리에이터의 저가 장비부터 프로덕션 스튜디오의 전문 장비까지 폭넓게 대응한다.

---

## 2. 핵심 기획

### 2.1 트래커 데이터 파이프라인

트래커 데이터는 아래 단계를 거쳐 아바타에 적용된다.

| 단계 | 동작 | 설명 |
|------|------|------|
| 1 | 장비 입력 | 물리 장비로부터 실시간 데이터 수신 |
| 2 | TrackerData 변환 | 장비별 데이터를 통일된 구조로 변환 |
| 3 | Puppet 생성 | 트래커별 중간 본 계층 구조 생성 |
| 4 | 리타게팅 | 본 매핑 및 IK 계산을 통해 아바타 본에 맞춤 |
| 5 | 아바타 적용 | 최종 아바타 본에 포즈 적용 |
| 6 | 네트워크 동기화 | 적용된 포즈를 네트워크로 전송 |

### 2.2 액터와 트래커 관계

하나의 Actor(액터)에는 아래 트래커가 각 1개씩 할당된다.

| 트래커 | 역할 | 필수 여부 |
|--------|------|----------|
| **Facial Tracker** | 얼굴 표정 (52종 BlendShape) | 선택 |
| **Motion Tracker** | 신체 움직임 (본 회전) | 선택 |
| **Hand Tracker** | 손가락 움직임 (30개 본) | 선택 |

> 모든 트래커는 선택 사항이다. 연결하지 않은 트래커의 해당 부위는 기본 포즈를 유지한다.

> 일부 Motion Tracker는 Facial/Hand 또한 움직일 수 있다.

### 2.3 Facial Tracker (얼굴 트래킹)

#### 지원 장비

| 장비 | 연결 방식 | 설명 |
|------|--------|------|
| **iFacialMocap** | WiFi/UDP| iPhone 기반, 가장 보편적 |
| **VTube Studio** | 로컬 API | 기존 VTS 사용자 대상 |
| **Facemotion3D** | WiFi/UDP | iPhone 기반, iFacial과 VIRDY 내부 기능 차이 없음 |
| **OpenSeeFace** | 로컬 | 무료, 웹캠 기반 |
| **OSC Protocol** | OSC | 범용 프로토콜, 커스텀 연동 |

#### 페이셜 민감도 설정

사용자가 부위별로 트래킹 반영 정도를 조절할 수 있다.

| 파라미터 | 범위 | 설명 |
|----------|------|------|
| 시선 강도 (Gaze) | 0~1 | 눈동자 움직임 반영 정도 |
| 눈썹 강도 (Eyebrow) | 0~1 | 눈썹 움직임 반영 정도 |
| 입/볼 강도 (Mouth) | 0~1 | 입과 볼 움직임 반영 정도 |

Facial Blendshape Config를 통해 더욱 상세한 설정이 가능하다.

#### Spine 연동

페이셜 트래킹만 사용할 때, 머리 방향에 따라 상체(Spine)가 자연스럽게 따라 움직이는 기능이다.

| 파라미터 | 설명 |
|----------|------|
| Scale | Spine 회전 크기 조절 |
| Lerp | Spine 회전 보간 속도 조절 |

### 2.4 Motion Tracker (바디 트래킹)

#### 지원 장비

| 장비 | 연결 방식 | 가격대 | 대상 | 설명 |
|------|----------|--------|------|------|
| **SteamVR** | SteamVR API | 중저가 | 개인 크리에이터 | 컨트롤러 + 트래커 조합 |
| **VMC Protocol** | UDP/OSC | 무료 | 개인 크리에이터 | 다른 모캡 앱과 연동 |
| **Xsens** | 전용 SDK | 고가 | 개인/기업 크리에이터 | 관성 센서 기반 |
| **MOVIN** | 전용 SDK | 고가 | 개인/기업 크리에이터 | 관성 센서 기반 |
| **Vicon** | DataStream SDK | 최고가 | 전문 스튜디오 | 광학 기반, 최고 품질 |

#### SteamVR 트래커 할당

SteamVR 사용 시, 물리 장치를 신체 부위에 할당한다.

| 부위 | 장치 예시 |
|------|----------|
| 머리 | Tracker 1 혹은 HMD |
| 왼손 | Controller L |
| 오른손 | Controller R |
| 허리 | Tracker 2 |
| 왼발 | Tracker 3 |
| 오른발 | Tracker 4 |

추가 옵션:
- 화면에 SteamVR 트래커 위치 시각화
- 모션 미러링 (좌우 반전)
- 캘리브레이션 포즈: T Pose, I Pose 지원

#### Vicon 특이사항

| 항목 | 설명 |
|------|------|
| 리타게팅 | 별도의 고급 리타게팅 처리 사용 |
| 미러링 | Vicon 자체 미러링 방식 적용 (일반 미러링과 분리) |
| Prop 트래킹 | 소품(Props) 트래킹 지원 — 물체를 별도로 트래킹하며 Hand와 세밀한 인터랙션 |

### 2.5 Hand Tracker (핸드 트래킹)

#### 지원 장비

| 장비 | 연결 방식 | 특징 | 대상 |
|------|----------|------|------|
| **Leap Motion** | USB/전용 SDK | 책상 위 센서, 저렴 | 개인 크리에이터 |
| **Mollisen** | 전용 SDK | 장갑형 | 개인 크리에이터 |
| **Manus** | 전용 SDK | 장갑형, 고품질 | 전문가 |
| **StretchSense** | 전용 SDK | 장갑형 | 전문가 |

#### 손가락 본 구조

| 구분 | 본 수 | 설명 |
|------|-------|------|
| 왼손 | 15개 | 엄지~새끼 각 3관절 |
| 오른손 | 15개 | 엄지~새끼 각 3관절 |
| 합계 | 30개 | 네트워크 동기화 시 40개 muscle 값으로 전송 |

#### Leap Motion 설정

| 파라미터 | 설명 |
|----------|------|
| 모션 강도 | 손가락 움직임 반영 정도 |
| 위치 오프셋 (X/Y/Z) | 센서 위치 보정 |
| 회전 오프셋 (X/Y/Z) | 센서 방향 보정 |

#### Mollisen 캘리브레이션

Mollisen 장갑은 2단계 캘리브레이션이 필요하다.

| 단계 | 포즈 | 동작 |
|------|------|------|
| 1단계 (MIN) | 보자기 (손 최대 펴기) | 최소값 기준점 설정 |
| 2단계 (MAX) | 주먹 (손 최대 쥐기) | 최대값 기준점 설정 |

캘리브레이션 모드: 양손 / 왼손만 / 오른손만 선택 가능

### 2.6 SteamVR 캘리브레이션 시스템

#### 캘리브레이션 모드

| 모드 | 포즈 | 용도 |
|------|------|------|
| **T-Pose** | 양팔 수평 펴기 | 바디 트래킹 기본 캘리브레이션 |
| **I-Pose** | 차렷 자세 | 대체 캘리브레이션 |

#### 캘리브레이션 플로우

| 단계 | 동작 |
|------|------|
| 1 | 캘리브레이션 포즈 선택 및 시작 버튼 클릭 |
| 2 | T-Pose 또는 I-Pose 실루엣, 캘리 안내 메시지 표시 |
| 3 | 카운트다운 (초 단위) |
| 4 | 포즈 캡처 및 기준점 설정 |
| 5 | 캘리브레이션 완료 → 정상 트래킹 시작 |

## 3. 설계 시 고려사항

### 3.1 장비별 연결 방식 차이

각 장비마다 연결 프로토콜이 다르므로, 통일된 TrackerData 인터페이스로 추상화해야 한다.

| 연결 유형 | 해당 장비 | 고려사항 |
|----------|----------|---------|
| WiFi/UDP | iFacialMocap, Facemotion3D | 네트워크 지연, 방화벽 |
| 로컬 API | VTube Studio, OpenSeeFace | 포트 충돌 가능 |
| OSC | OSC Protocol, VMC | 표준 프로토콜, 설정 유연 |
| 전용 SDK | SteamVR, Vicon, Xsens, MOVIN, Manus, Mollisen, StretchSense, Leap Motion | SDK 버전 관리, 라이선스 |

### 3.2 다중 트래커 우선순위

Facial + Motion + Hand가 동시에 활성화될 때 본 충돌을 방지해야 한다.

- Eye 본은 Facial 전용으로 처리 (Motion에서 제외)
- 손가락 본은 Hand 전용으로 처리 (Motion에서 제외)
- 나머지 본은 Motion이 우선

### 3.3 Vicon 예외 처리

Vicon은 다른 장비와 처리 방식이 다르다.

- 별도 리타게팅 컴포넌트 사용
- 미러링 로직 분리
- 세밀한 Prop 트래킹 추가 지원

---

## 4. 엣지 케이스 및 예외 처리

| 상황 | 대응 |
|------|------|
| 트래커 연결 중 장비 연결 해제 | 마지막 포즈 프리징 (혹은 장비 Timeout용 대기 모션 재생), 재연결 안내 |
| WiFi 트래커 네트워크 지연 | 프레임 보간으로 끊김 방지 |
| SteamVR 트래커 할당 충돌 (동일 장치 중복) | 경고 표시, 재할당 유도 |
| 캘리브레이션 미 진행 상태로 월드 진입 시도 | 캘리브레이션/리타게팅 안내 |
| Facial만 연결 시 | Spine은 기본 연동, 추후 Facial Pendulum Tracking 지원 |

---

## 5. 향후 확장 가능성

| 항목 | 설명 | 우선순위 |
|------|------|---------|
| **웹캠 페이셜** | XRAnimator, WebCam Motioncapture 등 웹캠 기반 얼굴 트래킹 추가 | 높음 |
| **트래커 프리셋** | 자주 쓰는 장비 조합을 프리셋으로 저장 | 중간 |
| **MotionBuilder 연동** | Autodesk MotionBuilder 실시간 스트리밍 | 낮음 |
| **Optitrack** | 광학 모캡 추가 지원 | 낮음 |
| **자동 장비 감지** | 연결된 장비 자동 인식 및 설정 제안 | 장기 |

---

## 관련 문서

- [아바타 시스템](./01_Avatar_System.md)
- [네트워크 시스템](./05_Network_System.md)
- [UI 기획](../04_Design/01_UI_Specification.md)
- [사용자 플로우](../01_Product/02_User_Flow.md)
