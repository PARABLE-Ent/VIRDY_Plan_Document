# 네트워크 시스템

> **문서 버전**: 1.0
> **최종 수정일**: 26.01.30 13:20
> **작성자**: 임경섭

---

## 1. 개요

네트워크 시스템은 Photon Fusion Shared Mode를 기반으로 VIRDY의 실시간 멀티유저 협업을 지원한다. 최대 100명이 동시 접속하여 아바타, 카메라, 채팅을 실시간으로 동기화하며, 데이터 압축과 보간 기술로 네트워크 대역폭을 최적화한다.

---

## 2. 핵심 기획

### 2.1 네트워크 구성요소

| 구성요소 | 역할 |
|----------|------|
| **FusionService** | 세션 수명주기 관리 (생성, 참가, 종료) |
| **FusionLobby** | 로비 연결 및 세션 검색 |
| **NetworkGame** | 세션 루트 오브젝트 (플레이어, 채널, 액터 관리) |
| **NetworkPlayer** | 플레이어별 인증 정보 및 위치 동기화 |
| **NetworkActor** | 아바타 본/표정/손가락 동기화 |
| **NetworkChannel** | 카메라 위치/설정/Channel Link 동기화 |
| **ChatService** | Photon Chat 기반 텍스트 채팅 및 초대 시스템 |

### 2.2 기본 설정

| 항목 | 값 |
|------|-----|
| 게임 모드 | Photon Fusion Shared Mode |
| 최대 플레이어 | 100명 |
| 로비 유형 | Custom |
| 로비 이름 | VIRDY.{버전} |
| 세션 코드 | 4자리 영숫자 (예: A1B2) |

### 2.3 세션 생성 및 참가

#### 세션 생성

| 단계 | 동작 |
|------|------|
| 1 | 사용자가 월드를 선택하고 "세션 생성" 클릭 (Free 플랜 제외) |
| 2 | 4자리 랜덤 세션 코드 생성 |
| 3 | 세션 속성에 worldId 포함 |
| 4 | Photon 세션 생성 → 월드 로딩 → 접속 완료 |

#### 세션 참가

| 방법 | 설명 |
|------|------|
| 세션 코드 입력 | 4자리 코드를 입력하여 세션에 참가 |
| 친구 초대 수락 | Chat으로 받은 초대를 수락하여 참가 |
| 따라가기 | 친구가 있는 세션에 참가 요청 |

### 2.4 세션 연결 플로우

#### 연결 과정

| 단계 | 동작 | 상태 표시 |
|------|------|----------|
| 1 | 로비 Runner 종료 | "초기화 중..." |
| 2 | Firebase Storage에서 월드 다운로드 | "월드 데이터 다운로드 중... (XX%)" |
| 3 | AssetBundle 로드 | "씬 로딩 중..." |
| 4 | NetworkRunner 생성 및 세션 참가 | "세션 접속 중..." |
| 5 | 연결 대기 (30초 타임아웃) | - |
| 6 | Photon Chat 채널 구독 | - |
| 7 | WorldScene 로드 대기 | - |
| 8 | NetworkGame 초기화 완료 | 로딩 해제 |

#### 연결 해제 과정

| 단계 | 동작 |
|------|------|
| 1 | 채팅 구독 해제 |
| 2 | NetworkRunner 종료 |
| 3 | 월드 언로드 (AssetBundle 메모리 해제) |
| 4 | 로비 복귀 |

### 2.5 네트워크 오브젝트 계층

세션에 접속하면 아래 오브젝트가 플레이어별로 생성된다.

| 오브젝트 | 수량 | 설명 |
|----------|------|------|
| NetworkGame | 1개 (세션당) | 모든 플레이어/채널/액터를 관리하는 루트 |
| NetworkPlayer | 1개 (플레이어당) | 사용자 정보, 아바타 위치 |
| NetworkChannel | 1개 (플레이어당) | 10개 카메라 + Channel Link |
| NetworkActor | 최대 6개 (플레이어당) | 아바타별 본/표정/손가락 |

### 2.6 아바타 동기화 데이터

| 데이터 | 수량 | 설명 |
|--------|------|------|
| 본 회전 | 22개 | Hips ~ Toes (Quaternion) |
| 손가락 포즈 | 40개 | 양손 각 20개 (muscle 값) |
| 표정(BlendShape) | 100개 | ARKit 52종 + 확장 |
| 위치 | 3개 | Hip 위치 + 손 오프셋 |

#### 동기화 본 목록 (22개)

| 부위 | 본 |
|------|-----|
| 몸통 | Hips, Spine, Chest, UpperChest, Neck, Head |
| 왼팔 | LeftShoulder, LeftUpperArm, LeftLowerArm, LeftHand |
| 오른팔 | RightShoulder, RightUpperArm, RightLowerArm, RightHand |
| 왼다리 | LeftUpperLeg, LeftLowerLeg, LeftFoot, LeftToes |
| 오른다리 | RightUpperLeg, RightLowerLeg, RightFoot, RightToes |

### 2.7 FPS 모드 동기화

아바타를 월드 내에서 WASD로 이동할 때의 동기화 데이터:

| 데이터 | 설명 |
|--------|------|
| IsFPSMode | FPS 모드 활성화 여부 |
| FPSPosition | FPS 위치 |
| FPSRotation | FPS 회전 |
| FPSSpeed | 이동 속도 |
| FPSAnimationState | 애니메이션 상태 (Idle/Walk/Jump/Run) |

### 2.8 Props 동기화

Vicon 등 전문 장비에서 소품(Props) 트래킹 시 동기화:

| 항목 | 설명 |
|------|------|
| 최대 수량 | 20개 |
| 동기화 데이터 | 이름, 위치, 회전 |

### 2.9 Sync 모드 (동기화 품질)

네트워크 동기화 품질은 **Live**와 **Ultra** 두 가지 모드로 구분되며, 구독 플랜에 따라 제공 범위가 달라진다.

| 모드 | 대상 플랜 | 특징 | 용도 |
|------|----------|------|------|
| **Live Sync** | 모든 플랜 | 경량 모션 데이터, 비용 효율적 | 일반 방송, 개인 사용 |
| **Ultra Sync** | Enterprise 전용 | 고품질 모션 데이터, 높은 대역폭 | 공연, 특수 연출, 전문 프로덕션 |

#### Live Sync

| 항목 | 설명 |
|------|------|
| 대상 | 모든 구독 플랜 (무료 포함) |
| 데이터 전송량 | 경량화된 모션 데이터 |
| 비용 효율 | 높음 |
| 품질 | 일반 사용에 충분한 수준 |

#### Ultra Sync

| 항목 | 설명 |
|------|------|
| 대상 | Enterprise 플랜 전용 |
| 데이터 전송량 | 고용량 모션 데이터 |
| 비용 효율 | 낮음 (대역폭 비용 높음) |
| 품질 | 전문 프로덕션 수준 |
| 조건 | 네트워크 품질 기준 충족 필요 |

#### Sync 모드 설계 원칙

- Sync 품질은 기술 옵션이 아닌 **비용 및 계약 개념**으로 관리
- 현재 사용 중인 고용량 모션 데이터는 일반 사용에 부적합
- Live Sync 전용으로 최적화된 경량 모션 데이터 개발 필요
- Ultra Sync 네트워크 조건 미달 시 Live로 자동 전환

> Sync 모드별 구독 플랜은 [라이선스 체계](../03_Operations/02_License_System.md) 참조

### 2.10 데이터 압축

네트워크 대역폭 절감을 위해 다양한 압축 기법을 적용한다.

| 데이터 유형 | 원본 크기 | 압축 후 | 절감률 |
|------------|----------|--------|-------|
| Quaternion (본 회전) | 16 bytes | 8 bytes (short×4) | 50% |
| BlendShape (표정) | 4 bytes | 1 byte (sbyte) | 75% |
| Position (위치) | Accuracy(0.1f) 양자화 | 가변 | 가변 |

추가 최적화:
- 변경 감지: 유의미한 변경이 있는 데이터만 전송
- 분산 액터 업데이트: 프레임당 최대 3명의 액터만 서버에 업데이트 (라운드 로빈)

### 2.11 보간 시스템

원격 플레이어의 움직임을 부드럽게 표시하기 위한 보간 처리:

| 항목 | 설명 |
|------|------|
| 히스토리 버퍼 | 2프레임 히스토리 |
| 본 회전 | Quaternion Slerp 보간 |
| 위치 | 선형 보간 |
| 업데이트 주기 | StateAuthority: FixedUpdate / Proxy: Render |

### 2.12 채팅 시스템

Photon Chat을 활용한 텍스트 채팅 및 소셜 기능:

#### 채팅 기능

| 기능 | 설명 |
|------|------|
| 전체 채팅 | 세션 내 모든 사용자에게 메시지 전송 |
| 팀 채팅 | 팀원에게만 메시지 전송 |

#### 소셜 명령

| 명령 | 기능 | 설명 |
|------|------|------|
| /invite | 초대 | 친구에게 현재 세션 참가 요청 |
| /follow | 따라가기 | 친구가 있는 세션에 참가 요청 |
| /bring | 데려오기 | 친구를 내 세션으로 이동 |

#### 재연결 전략

| 시도 | 대기 시간 |
|------|----------|
| 1~6회 | 5초 |
| 7회 이상 | 60초 |
| 최대 시도 초과 | 연결 실패 알림 |

### 2.13 RPC 사용 패턴

주요 데이터 동기화에 사용되는 RPC 패턴:

| 용도 | 방향 | 채널 |
|------|------|------|
| 플레이어 초기화 | StateAuthority → All | Reliable |
| 채팅 메시지 | All → All | Reliable |
| 라이팅 동기화 | StateAuthority → Proxies | Reliable |
| Channel Link 요청 | All → StateAuthority | Reliable |
| 스폰포인트 제어 | All → StateAuthority | Reliable |

### 2.14 Light / PostProcess 네트워크 동기화

세션 내 Directional Light와 PostProcess 파라미터는 모든 유저에게 공유되는 세션 전역 상태이다. 어떤 유저든 Slider UI를 통해 값을 변경하면 RPC로 전체 세션에 전파된다.

#### 동기화 대상

| 기능 | 파라미터 | 설명 |
|------|----------|------|
| **Directional Light** | Intensity | 광원 강도 (0~10) |
| **Directional Light** | Rotation X | 수직 회전 / 태양 고도 (0°~360°) |
| **Directional Light** | Rotation Y | 수평 회전 / 태양 방위 (0°~360°) |
| **Bloom** | Threshold, Intensity, Scatter, Enable | 블룸 효과 파라미터 |
| **Color Adjustments** | Post Exposure, Contrast, Saturation, Enable | 색감 보정 파라미터 |

#### 동기화 플로우

| 단계 | 동작 |
|------|------|
| 1 | 유저가 Slider UI로 Light 또는 PostProcess 파라미터를 변경 |
| 2 | 로컬에 즉시 적용 (조작자 화면에 바로 반영) |
| 3 | StateAuthority → 모든 Proxy로 Reliable RPC 전송 |
| 4 | 수신한 모든 유저의 화면에 동일한 값 적용 |

#### 동기화 특성

| 항목 | 설명 |
|------|------|
| 방향 | StateAuthority → Proxies |
| 채널 | Reliable |
| 제어 권한 | 세션 내 모든 유저가 조작 가능 |
| 충돌 정책 | Last-Write-Wins (마지막 RPC가 최종값) |
| 후속 참가자 | 세션 참가 시 현재 상태값을 수신하여 동기화 상태로 시작 |

### 2.15 스폰포인트 네트워크 제어

월드의 스폰포인트 위치를 네트워크를 통해 제어할 수 있다.

| 항목 | 설명 |
|------|------|
| 위치/회전 | 네트워크로 동기화 |
| 제어권 | 한 번에 1명만 스폰포인트 제어 가능 |
| 요청 방식 | RPC로 StateAuthority에 제어권 요청 |

---

## 3. 설계 시 고려사항

### 3.1 Shared Mode 특성

Photon Fusion Shared Mode를 사용하므로:

- 각 플레이어가 자신의 오브젝트에 대한 StateAuthority를 가짐
- 서버가 아닌 클라이언트가 자신의 데이터를 직접 업데이트
- 호스트 없이 모든 클라이언트가 동등한 권한

### 3.2 대역폭 관리

100명 동시 접속 시 데이터 양이 급증하므로:

- 프레임당 최대 3명의 액터만 서버 업데이트 (분산 처리)
- Quaternion 50% 압축 + BlendShape 75% 압축
- 유의미한 변경만 전송 (변경 감지)
- 위치 데이터 양자화

### 3.3 버전 호환성

로비 이름에 버전을 포함 (VIRDY.{버전})하여 서로 다른 버전의 클라이언트가 같은 세션에 접속하는 것을 방지한다.

### 3.4 세션 속성

세션에 worldId를 포함시켜 참가자가 올바른 월드를 다운로드하도록 보장한다.

---

## 4. 엣지 케이스 및 예외 처리

| 상황 | 대응 |
|------|------|
| 세션 코드 오류 (존재하지 않는 코드) | "세션을 찾을 수 없습니다" 오류 표시 |
| 연결 대기 타임아웃 (30초) | 자동 연결 해제, 오류 알림, 로비 복귀 |
| 월드 다운로드 실패 | 연결 해제, 오류 알림 |
| 예기치 않은 연결 끊김 | 자동 연결 해제, 로비 복귀 |
| Chat 연결 끊김 | 지수 백오프 자동 재연결 (5초 → 60초) |
| Chat 재연결 최대 시도 초과 | 연결 실패 알림 표시 |
| 이중 Channel Link 시도 | "이중 공유는 불가능합니다" 경고 |
| 스폰포인트 제어 충돌 | 이미 다른 사용자가 제어 중이면 요청 거부 |
| 세션 최대 인원(100명) 초과 | 참가 거부, 안내 메시지 |

---

## 5. 향후 확장 가능성

| 항목 | 설명 | 우선순위 |
|------|------|---------|
| **음성 채팅** | 세션 내 실시간 음성 통화 | 중간 |
| **세션 녹화/재생** | 모션 데이터 녹화 및 재생 | 중간 |
| **로컬 모드** | 네트워크 없이 단독 사용 | 중간 |
| **서버 리전 선택** | 사용자가 가까운 서버 선택 | 낮음 |
| **관전 모드** | 참가하지 않고 세션 관전 | 장기 |

---

## 관련 문서

- [월드 시스템](./04_World_System.md)
- [카메라 시스템](./03_Camera_System.md)
- [사용자 플로우](../01_Product/02_User_Flow.md)
- [기술 아키텍처](../05_Technical/01_Architecture.md)
- [라이선스 체계](../03_Operations/02_License_System.md)
- [리스크 관리](../03_Operations/05_Risk_Management.md)
- [보안 시스템](../03_Operations/03_Security.md)
