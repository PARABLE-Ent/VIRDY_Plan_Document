# 보안 시스템

> **문서 버전**: 1.1
> **최종 수정일**: 26.02.03 18:00
> **작성자**: 임경섭

---

## 1. 개요

VIRDY의 보안 시스템은 인증, 데이터 보호, 아바타 저작권 보호를 중심으로 설계된다. 현행 시스템은 Firebase 서비스(Auth, Firestore 보안 규칙, Functions)를 기반으로 하며, 서버 아키텍처 전환 검토(서버 개발자 회의, 2026.02)에 따라 JWT 기반 인증, Photon Webhook 보안, Signed URL 기반 파일 접근 제어가 추가될 수 있다.

---

## 2. 핵심 기획

### 2.1 보안 아키텍처

| 계층 | 서비스 | 역할 |
|------|--------|------|
| 인증 | Firebase Auth | 이메일/비밀번호 인증, 토큰 관리 |
| 데이터 보호 | Firestore 보안 규칙 | 사용자/월드/아바타 데이터 접근 제어 |
| 서버 로직 | Firebase Functions | 서버 측 검증, 민감 작업 처리 |
| 파일 저장 | Firebase Storage | 보안 규칙 기반 파일 접근 제어 |
| 아바타 보호 | VRM 암호화 | 아바타 파일 암호화 저장 |

### 2.2 인증 시스템

#### 이메일 기반 인증

| 단계 | 동작 |
|------|------|
| 회원가입 | Firebase Functions (signUpV2)를 통해 계정 생성 |
| 이메일 인증 | Firebase Auth 이메일 인증 발송 → 인증 완료 필수 |
| 로그인 | 이메일 + 비밀번호로 인증, 이메일 인증 완료 확인 |
| 사용자명 로그인 | 사용자명 → Firebase Function으로 이메일 조회 → 이메일 로그인 |
| 비밀번호 리셋 | Firebase Auth 비밀번호 리셋 이메일 발송 |

#### 인증 토큰

| 항목 | 설명 |
|------|------|
| 토큰 방식 | Firebase Auth 토큰 (자동 갱신) |
| 세션 유지 | Firebase SDK가 토큰 수명주기 관리 |
| 로그아웃 | Firebase Auth 로그아웃 → 토큰 무효화 |

### 2.3 Firestore 보안 규칙

Firestore 보안 규칙을 통해 데이터 접근을 제어한다.

#### 사용자 데이터

| 규칙 | 설명 |
|------|------|
| 읽기 | 인증된 사용자만 자신의 데이터 읽기 |
| 쓰기 | Firebase Functions를 통해서만 수정 (직접 쓰기 차단) |

#### 월드 데이터

| 유형 | 읽기 규칙 | 쓰기 규칙 |
|------|----------|----------|
| Public 월드 | 모든 인증 사용자 | 제작자만 (Functions 경유) |
| Private 월드 | 제작자만 | 제작자만 (Functions 경유) |
| Private+ 월드 | 제작자 + sharedWith 목록 | 제작자만 (Functions 경유) |

#### 아바타 데이터

| 규칙 | 설명 |
|------|------|
| 읽기 | 소유자만 |
| 쓰기 | 소유자만 |
| 타인 접근 | Firebase 보안 규칙으로 차단 |

### 2.4 Firebase Functions

민감한 작업은 클라이언트에서 직접 수행하지 않고 Firebase Functions를 통해 서버 측에서 처리한다.

| 함수 | 용도 |
|------|------|
| signUpV2 | 회원가입 (계정 생성 + Firestore 저장) |
| getEmailByUsername | 사용자명 → 이메일 조회 |
| saveWorld | 월드 메타데이터 저장 |
| deleteWorld | 월드 삭제 (Firestore + Storage) |
| getWorldData | 월드 메타데이터 조회 |

### 2.5 아바타 파일 보호

#### VRM 암호화

| 항목 | 설명 |
|------|------|
| 대상 | VRM 아바타 파일 |
| 업로드 시 | 암호화 후 Firebase Storage 저장 |
| 로컬 캐시 | 암호화 상태로 캐시 저장 |
| 로드 시 | 복호화 후 메모리에서 사용 |
| 목적 | 파일 직접 추출 방지, 저작권 보호 |

#### VRM 저작권 정보 존중

| 메타데이터 | 설명 |
|-----------|------|
| AllowedUser | 허용 사용자 범위 |
| ViolentUsage | 폭력적 사용 허용 여부 |
| SexualUsage | 성적 사용 허용 여부 |
| CommercialUsage | 상업적 사용 허용 여부 |

### 2.6 네트워크 보안

#### Photon 세션

| 항목 | 설명 |
|------|------|
| 세션 접근 | 세션 코드를 아는 사용자만 참가 |
| 로비 분리 | 버전별 로비 분리 (VIRDY.{버전}) |
| 데이터 전송 | Photon 서버를 통한 암호화 전송 |

#### Chat 보안

| 항목 | 설명 |
|------|------|
| 인증 | Firebase UserId로 Photon Chat 인증 |
| 개인 메시지 | 초대/따라가기/데려오기 등 명령은 Private Message로 전송 |
| 팀 채팅 | 역할 기반 필터링 (클라이언트 측) |

### 2.7 Firebase Storage 보안

| 항목 | 설명 |
|------|------|
| 아바타 파일 | 소유자만 읽기/쓰기 |
| 월드 파일 | 공개 설정에 따라 접근 제어 |
| 썸네일 | 월드 공개 설정에 따라 공개 |
| 전송 | HTTPS 암호화 |

### 2.8 보안 아키텍처 전환 검토 (서버 개발자 회의 기반)

> 🚧 아래 내용은 서버 개발자 회의(2026.02) 기반 검토 사항이다. 비용 및 기술적 타당성에 따라 변동될 수 있다.

서버 아키텍처 전환 시 보안 계층이 다음과 같이 강화된다.

#### JWT 기반 인증 보안 (검토 중)

| 항목 | 설명 |
|------|------|
| Access Token | 1시간 만료, API 호출마다 서명 검증 |
| Refresh Token | 7~30일 만료 (미확정), 안전한 로컬 저장소 보관 |
| JWT Payload | userId, tenantId, role, subscriptionPlan 포함 |
| 서버 측 검증 | 모든 API 요청에서 JWT 서명/만료/권한 검증 수행 |

현행 Firebase Auth 토큰과 달리, JWT에 구독 플랜과 역할 정보를 직접 포함하여 API 호출마다 서버 측에서 권한을 검증할 수 있다.

#### Photon Custom Authentication (검토 중)

Photon 세션 접속 시 VIRDY Backend를 통한 인증을 필수로 설정하여, AppID 탈취로 인한 무단 사용을 방지한다.

| 단계 | 동작 |
|------|------|
| 1 | Unity Client가 Photon에 연결 요청 (JWT 포함) |
| 2 | Photon이 Backend로 Auth 검증 요청 (JWT 전달) |
| 3 | Backend에서 JWT 서명/만료/구독 확인 |
| 4 | 인증 결과를 Photon에 반환 |
| 5 | Photon이 Client에 연결 허용/거부 |

#### Photon Webhook 보안 (검토 중)

| 항목 | 설명 |
|------|------|
| Webhook Secret | Photon → Backend 요청 시 Secret으로 요청 검증 |
| 이벤트 종류 | Room 생성/종료, Player 입장/퇴장 |
| Backend 처리 | 세션 상태 DB 저장, 참가자 수 관리 |

#### Cloudflare R2 Signed URL 보안 (검토 중)

| 항목 | 설명 |
|------|------|
| 업로드 | Backend에서 시간 제한 Signed URL 발급 → 클라이언트가 R2에 직접 업로드 |
| 다운로드 | Backend에서 권한 확인 후 Signed URL 발급 → 클라이언트가 R2에서 직접 다운로드 |
| Egress 비용 | Cloudflare R2는 Egress 무료 (Firebase Storage 대비 비용 절감) |
| URL 만료 | 시간 제한으로 URL 유출 시에도 재사용 불가 |

---

## 3. 설계 시 고려사항

### 3.1 클라이언트 측 보안 한계

현재 일부 검증이 클라이언트 측에서만 수행된다.

| 항목 | 현재 | 개선 방향 |
|------|------|----------|
| 액터 수 제한 | 클라이언트 상수 | 서버 측 검증 추가 |
| 역할 확인 | Firestore 평문 저장 | 난독화 또는 서버 측 검증 |
| 라이선스 | 빌드 타임 심볼 | 라이선스 서버 도입 |

### 3.2 아바타 저작권 보호 강화

VRM 파일은 암호화하지만, 메모리에서 복호화된 상태에서 추출 가능성이 있다. 추가 보호 조치:

- 런타임 메모리 보호 (난독화)
- 워터마크 삽입
- DRM 수준 보호 (장기)

### 3.3 Firebase 의존도

보안이 Firebase 서비스에 강하게 의존하고 있다. Firebase 장애 시 전체 인증/데이터 접근이 불가하므로, 장기적으로 자체 인증 서버 백업을 고려할 수 있다.

---

## 4. 엣지 케이스 및 예외 처리

| 상황 | 대응 |
|------|------|
| 이메일 인증 미완료 로그인 | 인증 메일 재발송 안내 |
| 비밀번호 분실 | Firebase Auth 리셋 이메일 발송 |
| Firebase Auth 토큰 만료 | SDK 자동 갱신 |
| 타인의 아바타 다운로드 시도 | Firebase Storage 보안 규칙으로 차단 |
| 삭제된 월드 공유 링크 접근 | "월드를 찾을 수 없습니다" 오류 |
| Private 월드 권한 없는 접근 | Firestore 보안 규칙으로 차단 |
| 암호화된 아바타 파일 손상 | 재다운로드 안내 |
| 세션 코드 브루트포스 | 4자리 코드 + 버전 로비 분리로 완화 |

---

## 5. 향후 확장 가능성

| 항목 | 설명 | 우선순위 |
|------|------|---------|
| **서버 측 라이선스 검증** | JWT 기반 서버 측 구독/권한 검증 | 높음 |
| **Photon Custom Auth** | Backend를 통한 Photon 접속 인증 | 높음 |
| **Webhook Secret 검증** | Photon Webhook 요청의 무결성 검증 | 높음 |
| **소셜 로그인** | Google, Steam 등 OAuth 연동 | 중간 |
| **2단계 인증** | OTP 또는 인증 앱 연동 | 낮음 |
| **DRM 강화** | 아바타/월드 파일 DRM 보호 | 장기 |
| **런처 인증** | 자동 업데이트 + 토큰 인증 런처 | 중간 |
| **감사 로그** | 사용자 행동 로깅 및 모니터링 | 중간 |

---

## 관련 문서

- [라이선스 체계](./02_License_System.md)
- [사용자 역할](./01_User_Roles.md)
- [계정 시스템](./06_Account_System.md)
- [데이터 생명주기](./04_Data_Lifecycle.md)
- [리스크 관리](./05_Risk_Management.md)
- [아바타 시스템](../02_Features/01_Avatar_System.md)
- [네트워크 시스템](../02_Features/05_Network_System.md)
