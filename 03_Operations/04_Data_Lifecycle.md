# 데이터 생명주기

> **문서 버전**: 1.0
> **최종 수정일**: 26.01.30 13:20
> **작성자**: 임경섭

---

## 1. 개요

이 문서는 VIRDY 서비스 내 모든 데이터의 생성, 보관, 아카이브, 삭제에 대한 정책을 정의한다. 데이터 유형별로 보관 기간과 처리 방식을 명확히 하여 운영 비용을 최적화하고 사용자 자산을 보호한다.

---

## 2. 핵심 기획

### 2.1 데이터 유형 분류

| 유형 | 예시 | 복구 필요성 | 보관 기간 |
|------|------|------------|----------|
| **유저 자산 데이터** | 아바타, 월드 | 필수 | 장기 (정책에 따라) |
| **계정 데이터** | 프로필, 설정, 친구 목록 | 필수 | 계정 삭제 전까지 |
| **로그성 데이터** | 세션 로그, 접속 기록 | 불필요 | 30~90일 |
| **실시간 세션 데이터** | 방 상태, 채팅 | 불필요 | 세션 종료 즉시 파기 |
| **법적/보안 로그** | 결제 기록, 보안 이벤트 | 법적 요구 | 법적 요구 범위 내 |

### 2.2 유저 자산 데이터

유저 자산은 바로 지우면 안 되는 데이터로, 신중한 생명주기 관리가 필요하다.

| 자산 | 저장 위치 | 설명 |
|------|----------|------|
| **아바타** | Firebase Storage | VRM 파일 (암호화 저장) |
| **월드** | Firebase Storage | AssetBundle 파일 |
| **메타데이터** | Firestore | 아바타/월드 설정, 공유 정보 |

### 2.3 로그성 데이터

복구 불가능해도 되는 데이터:

| 데이터 | 보관 기간 | 비고 |
|--------|----------|------|
| 세션 로그 | 30~90일 | 디버깅, 분석용 |
| 접속 기록 | 30~90일 | 익명화 가능 |
| 서버 성능 로그 | 30~90일 | 모니터링용 |
| 에러 로그 | 30~90일 | 버그 추적용 |

---

## 3. 구독 상태별 데이터 처리

### 3.1 구독 활성 상태

| 상태 | 데이터 처리 |
|------|-----------|
| 구독 시작 | 플랜에 따른 스토리지 할당 |
| 구독 유지 | 정상 접근 및 사용 가능 |

### 3.2 구독 중단 시 처리 플로우

```
구독 중단
    ↓
[N일 유예 기간]
    - 데이터 접근 가능 (읽기 전용)
    - 아바타/월드 다운로드 가능
    ↓
[유예 기간 종료]
    - 아카이브로 데이터 이동
    - 서버 비용 감축 (Cold Storage)
    ↓
[장기 미복귀: 6~12개월]
    - 데이터 삭제
    - 단, 로그인 시 삭제 기간 리셋
    - 아카이브 이동 기간은 리셋하지 않음
```

### 3.3 구독 상태별 상세 정책

| 단계 | 기간 | 데이터 상태 | 사용자 액션 |
|------|------|-----------|-----------|
| **유예 기간** | 구독 종료 후 N일 | 읽기 전용 | 다운로드 가능 |
| **아카이브** | 유예 종료 후 | Cold Storage 이동 | 재구독 시 복원 |
| **삭제 대기** | 아카이브 후 6~12개월 | 삭제 예정 | 로그인 시 기간 리셋 |
| **완전 삭제** | 삭제 대기 종료 | 영구 삭제 | 복구 불가 |

### 3.4 플랜 등급 하락 시

| 상황 | 처리 |
|------|------|
| Enterprise → Studio | 초과 슬롯 데이터 아카이브 |
| Studio → Pro | 초과 슬롯 데이터 아카이브 |
| Pro → 무료 | 클라우드 데이터 아카이브, 로컬 다운로드 유도 |

---

## 4. 서버/멀티 세션 생명주기

> **용어 정리:** 내부적으로는 "세션(Session)"이라는 기술 용어를 사용하지만, 사용자에게는 "월드"와 "호스트"라는 용어로 노출된다. 이 문서에서는 기술 구현 관점에서 "세션"을 사용한다.

### 4.1 세션 생성 및 호스트

| 항목 | 정책 |
|------|------|
| **세션 생성 주체** | 유료 플랜(Pro/Studio/Enterprise) 사용자만 생성 가능 |
| **호스트 (세션 소유자)** | 세션을 생성한 사용자. UI에서 👑 왕관 아이콘으로 표시 |
| **동시 세션 제한** | Pro: 1개, Studio: 3개, Enterprise: 10개+ |

### 4.2 세션 유지 조건

세션은 **유료 플랜 사용자가 최소 1명 이상 접속** 중일 때만 유지된다.

| 조건 | 세션 상태 |
|------|----------|
| 유료 플랜 사용자 1명 이상 접속 | ✅ 정상 유지 |
| Free 사용자만 남음 | ⚠️ "0명" 취급 → 10분 유예 시작 |
| 접속 인원 0명 | ⚠️ 10분 유예 시작 |

**핵심 원칙:**
- Free 사용자는 세션 유지 인원으로 **카운트되지 않음**
- Free 사용자만 남은 세션 = 실질적으로 "빈 세션"으로 취급
- 10분 유예 기간 내 유료 사용자 재접속 시 세션 유지

### 4.3 호스트 퇴장 시 처리

호스트가 퇴장(팅김/나감)할 때의 처리 규칙:

| 상황 | 처리 |
|------|------|
| 호스트 퇴장 + 다른 유료 사용자 있음 | **즉시 이전하지 않음** → 10분 유예 시작 |
| 호스트 퇴장 + Free 사용자만 남음 | 10분 유예 후 세션 파기 |
| 호스트 퇴장 + 아무도 없음 | 10분 유예 후 세션 파기 |

**호스트 퇴장 후 유예 기간 (10분):**
- 호스트가 재접속하면 그대로 호스트 유지
- 유예 기간 종료 시 남은 유료 사용자에게 호스트 자동 이전
- Free 사용자만 남은 경우 세션 파기

### 4.4 호스트 이전 정책

#### 4.4.1 자동 이전 (유예 기간 종료 시)

호스트가 10분 유예 기간 내 복귀하지 않으면, 남은 유료 사용자 중 한 명에게 자동 이전된다.

**이전 대상 선정 우선순위:**
1. 동시 세션에 여유가 있는 사용자 (현재 호스트 중인 세션 수 < 플랜 제한)
2. 더 높은 플랜 (Enterprise > Studio > Pro)
3. 접속 시간이 가장 오래된 사용자

**이전 불가 시:**
- 모든 유료 사용자가 동시 세션 제한에 걸린 경우 → 세션 파기

#### 4.4.2 강제 이전 (호스트가 새 월드 생성 시)

호스트가 유예 기간 중 새 월드를 열려고 할 때:

| 단계 | 동작 |
|------|------|
| 1 | "월드 열기" 시도 |
| 2 | 동시 세션 제한 확인 → 기존 세션 존재 |
| 3 | "기존 월드 닫기" 확인 팝업 |
| 4 | 확인 시: 남은 유료 사용자에게 호스트 이전 후 새 세션 생성 |

**핵심:** 호스트 입장에서는 "월드 닫기"지만, 실제로는 남은 유료 사용자에게 호스트가 이전되는 동작이다.

### 4.5 호스트 표시 (UI)

| 요소 | 설명 |
|------|------|
| **왕관 아이콘 👑** | 플레이어 목록에서 호스트 옆에 표시 |
| **실시간 반영** | 호스트 이전 시 왕관도 즉시 이동 |
| **이전 알림** | "호스트가 변경되었습니다" 토스트 메시지 |

### 4.6 세션 파기 조건

| 조건 | 유예 기간 | 결과 |
|------|----------|------|
| 유료 사용자 0명 (실질적 0명) | 10분 | 세션 파기 |
| 물리적 접속 인원 0명 | 10분 | 세션 파기 |
| 호스트가 월드 닫기 (이전 대상 없음) | 즉시 | 세션 파기 |
| 호스트가 월드 닫기 (이전 대상 있음) | 즉시 | 호스트 이전 후 세션 유지 |

**유예 기간 동작:**
- 10분 카운트다운 시작
- 유예 기간 내 유료 사용자 재접속 시 카운트다운 리셋
- Free 사용자 접속은 카운트다운에 영향 없음
- 10분 경과 시 세션 자동 파기 또는 호스트 이전

### 4.7 세션 관리 UI

> **참고:** 세션 관리 UI 구성은 현재 검토 중이다. 상세 내용은 [UI 기획](../04_Design/01_UI_Specification.md) 참조.

### 4.8 세션 메타데이터

세션 종료 후에도 보존되는 데이터:

| 데이터 | 저장 방식 | 설명 |
|--------|----------|------|
| 룸 설정 | 계정 데이터 | 방 생성 시 재사용 가능 |
| 권한 설정 | 계정 데이터 | 매니저 권한 등 |
| 프리셋 | 계정 데이터 | 카메라, 조명 프리셋 |

---

## 5. 데이터 삭제 후 서버 보관 기간

| 데이터 유형 | 삭제 요청 후 보관 | 비고 |
|------------|-----------------|------|
| 실시간 세션 데이터 | 종료 즉시 파기 | - |
| 로그성 데이터 | 최대 90일 | 디버깅/분석 후 파기 |
| 유저 자산 데이터 | N일 보관 후 파기 | 복구 요청 대비 |
| 법적/보안 로그 | 법적 요구 범위 내 | 결제, 보안 이벤트 |

---

## 6. 설계 시 고려사항

### 6.1 비용 최적화

| 전략 | 설명 |
|------|------|
| **Cold Storage 활용** | 아카이브 데이터는 저비용 스토리지로 이동 |
| **개수 기반 제한** | 용량(GB)이 아닌 개수로 관리하여 예측 가능성 확보 |
| **자동 정리** | 비활성 계정 데이터 자동 아카이브/삭제 |

### 6.2 사용자 경험

| 원칙 | 설명 |
|------|------|
| **데이터 손실 방지** | 구독 종료 시 즉시 삭제 금지 |
| **충분한 유예 기간** | 다운로드 및 백업 시간 제공 |
| **명확한 안내** | 삭제 예정 시 사전 알림 |

### 6.3 벤치마킹 대상

| 서비스 | 참고 정책 |
|--------|----------|
| Google Drive | 구독 종료 후 데이터 보관 정책 |
| Dropbox | 계정 비활성 시 처리 정책 |
| Adobe Creative Cloud | 플랜 다운그레이드 시 파일 처리 |

---

## 7. 엣지 케이스 및 예외 처리

| 상황 | 대응 |
|------|------|
| 구독 종료 직전 대용량 업로드 | 유예 기간 내 다운로드 안내 |
| 아카이브 중 재구독 | 데이터 즉시 복원 |
| 삭제 대기 중 로그인 | 삭제 기간 리셋 (아카이브 기간은 유지) |
| 법적 요청으로 데이터 보존 필요 | 삭제 일시 중지, 법적 절차 따름 |
| 사용자 명시적 삭제 요청 | 즉시 접근 차단, 유예 후 완전 삭제 |

---

## 8. 미결정 쟁점

| 항목 | 상태 | 비고 |
|------|------|------|
| 유예 기간 구체적 일수 | 📋 논의 필요 | 7일? 14일? 30일? |
| 아카이브 후 삭제까지 기간 | 📋 논의 필요 | 6개월? 12개월? |
| 0명 세션 유지 시간 | ✅ 결정됨 | 10분 유예 후 파기 |
| 호스트 퇴장 후 유예 시간 | ✅ 결정됨 | 10분 유예 후 호스트 이전 또는 파기 |
| Cold Storage 구현 방식 | 📋 논의 필요 | Firebase 외 옵션 검토 |

---

## 9. 향후 확장 가능성

| 항목 | 설명 | 우선순위 |
|------|------|---------|
| **자동 아카이브 시스템** | 비활성 데이터 자동 이동 | 높음 |
| **데이터 내보내기** | 사용자 요청 시 전체 데이터 다운로드 | 중간 |
| **삭제 알림 시스템** | 삭제 예정 사전 이메일 알림 | 중간 |
| **데이터 복원 UI** | 아카이브 데이터 셀프 복원 | 낮음 |

---

## 관련 문서

- [라이선스 체계](./02_License_System.md)
- [계정 시스템](./06_Account_System.md)
- [보안 시스템](./03_Security.md)
- [리스크 관리](./05_Risk_Management.md)
